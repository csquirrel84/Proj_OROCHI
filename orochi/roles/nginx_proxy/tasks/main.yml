---
# ==============================================
# NGINX PORTAL - Simple Landing Page
# ==============================================

- name: Create Portal directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - "{{ directories.portal }}"
    - "{{ directories.portal }}/html"
  tags: portal

- name: Create Orochi landing page
  ansible.builtin.copy:
    dest: "{{ directories.portal }}/html/index.html"
    content: |
      <!DOCTYPE html>
      <html lang="en">
      <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>OROCHI Security Stack</title>
          <style>
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body {
                  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                  background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
                  min-height: 100vh;
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                  padding: 20px;
                  color: #fff;
              }
              .header {
                  text-align: center;
                  margin: 40px 0;
              }
              .header h1 {
                  font-size: 3.5em;
                  font-weight: 700;
                  letter-spacing: 2px;
                  text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
              }
              .header p {
                  font-size: 1.2em;
                  margin-top: 10px;
                  opacity: 0.9;
              }
              .services {
                  display: grid;
                  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                  gap: 25px;
                  max-width: 1200px;
                  width: 100%;
                  margin: 20px 0;
              }
              .service-card {
                  background: rgba(255, 255, 255, 0.95);
                  border-radius: 15px;
                  padding: 30px;
                  text-align: center;
                  transition: all 0.3s ease;
                  box-shadow: 0 8px 16px rgba(0,0,0,0.2);
                  cursor: pointer;
                  text-decoration: none;
                  color: #333;
                  display: block;
              }
              .service-card:hover {
                  transform: translateY(-5px);
                  box-shadow: 0 12px 24px rgba(0,0,0,0.3);
              }
              .service-card.unavailable {
                  opacity: 0.5;
                  cursor: not-allowed;
                  background: rgba(200, 200, 200, 0.5);
              }
              .service-card.unavailable:hover {
                  transform: none;
              }
              .service-icon {
                  height: 80px;
                  width: 80px;
                  margin: 0 auto 15px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
              }
              .service-icon img {
                  max-height: 100%;
                  max-width: 100%;
                  object-fit: contain;
              }
              .service-name {
                  font-size: 1.5em;
                  font-weight: 600;
                  margin-bottom: 10px;
                  color: #2a5298;
              }
              .service-desc {
                  font-size: 0.9em;
                  color: #666;
                  margin-bottom: 10px;
              }
              .service-url {
                  font-size: 0.8em;
                  color: #999;
                  font-family: monospace;
              }
              .footer {
                  margin-top: auto;
                  padding: 20px;
                  text-align: center;
                  opacity: 0.8;
              }
          </style>
      </head>
      <body>
          <div class="header">
              <h1>OROCHI</h1>
              <p>Security Stack Portal</p>
          </div>

          <div class="services">
              <a href="https://{{ orochi_server_ip }}:{{ ports.elasticsearch }}" class="service-card" target="_blank">
                  <div class="service-icon">
                      <img src="https://static-www.elastic.co/v3/assets/bltefdd0b53724fa2ce/blt36f2da8d650732a0/5d0823c3d8ff351753cbc99f/logo-elasticsearch-32-color.svg" alt="Elasticsearch">
                  </div>
                  <div class="service-name">Elasticsearch</div>
                  <div class="service-desc">Search & Analytics Engine</div>
                  <div class="service-url">https://{{ orochi_server_ip }}:{{ ports.elasticsearch }}</div>
              </a>

              <a href="https://{{ orochi_server_ip }}:{{ ports.kibana }}" class="service-card" target="_blank">
                  <div class="service-icon">
                      <img src="https://static-www.elastic.co/v3/assets/bltefdd0b53724fa2ce/blt4466841eed0bf232/5d082a5e97f2babb5af907ee/logo-kibana-32-color.svg" alt="Kibana">
                  </div>
                  <div class="service-name">Kibana</div>
                  <div class="service-desc">Data Visualization & SIEM</div>
                  <div class="service-url">https://{{ orochi_server_ip }}:{{ ports.kibana }}</div>
              </a>

              <a href="https://{{ orochi_server_ip }}:{{ ports.fleet }}" class="service-card" target="_blank">
                  <div class="service-icon">
                      <img src="https://static-www.elastic.co/v3/assets/bltefdd0b53724fa2ce/blt7f2d2f233ed49488/5eb26953c3a05b7d7b0a8304/logo-elastic-agent-32-color.svg" alt="Fleet">
                  </div>
                  <div class="service-name">Fleet Server</div>
                  <div class="service-desc">Agent Management</div>
                  <div class="service-url">https://{{ orochi_server_ip }}:{{ ports.fleet }}</div>
              </a>

              <a href="http://{{ orochi_server_ip }}:{{ ports.thehive }}" class="service-card" target="_blank">
                  <div class="service-icon">
                      <img src="https://raw.githubusercontent.com/TheHive-Project/TheHive/master/images/thehive-logo.png" alt="TheHive">
                  </div>
                  <div class="service-name">TheHive</div>
                  <div class="service-desc">Incident Response Platform</div>
                  <div class="service-url">http://{{ orochi_server_ip }}:{{ ports.thehive }}</div>
              </a>

              <a href="https://{{ orochi_server_ip }}:{{ ports.velociraptor_gui }}" class="service-card" target="_blank">
                  <div class="service-icon">
                      <img src="https://docs.velociraptor.app/velo_bike.png" alt="Velociraptor">
                  </div>
                  <div class="service-name">Velociraptor</div>
                  <div class="service-desc">DFIR & Endpoint Visibility</div>
                  <div class="service-url">https://{{ orochi_server_ip }}:{{ ports.velociraptor_gui }}</div>
              </a>

              <a href="http://{{ orochi_server_ip }}:{{ ports.arkime }}" class="service-card" target="_blank">
                  <div class="service-icon">
                      <img src="https://raw.githubusercontent.com/arkime/arkime/main/assets/Arkime_Logo_FullGradientBlack@2x.png" alt="Arkime">
                  </div>
                  <div class="service-name">Arkime</div>
                  <div class="service-desc">Full Packet Capture</div>
                  <div class="service-url">http://{{ orochi_server_ip }}:{{ ports.arkime }}</div>
              </a>

              <a href="http://{{ orochi_server_ip }}:{{ ports.cyberchef }}" class="service-card" target="_blank">
                  <div class="service-icon">
                      <img src="https://gchq.github.io/CyberChef/images/cyberchef-128x128.png" alt="CyberChef">
                  </div>
                  <div class="service-name">CyberChef</div>
                  <div class="service-desc">Data Analysis Toolkit</div>
                  <div class="service-url">http://{{ orochi_server_ip }}:{{ ports.cyberchef }}</div>
              </a>

              <a href="http://{{ orochi_server_ip }}:{{ ports.mattermost }}" class="service-card" target="_blank">
                  <div class="service-icon">
                      <img src="https://mattermost.com/wp-content/uploads/2022/02/icon.png" alt="Mattermost">
                  </div>
                  <div class="service-name">Mattermost</div>
                  <div class="service-desc">Team Communication</div>
                  <div class="service-url">http://{{ orochi_server_ip }}:{{ ports.mattermost }}</div>
              </a>

              <a href="http://{{ orochi_server_ip }}:{{ ports.rita }}" class="service-card" target="_blank">
                  <div class="service-icon">
                      <img src="https://raw.githubusercontent.com/activecm/rita/master/docs/images/rita_logo.png" alt="RITA">
                  </div>
                  <div class="service-name">RITA</div>
                  <div class="service-desc">Network Traffic Analytics</div>
                  <div class="service-url">http://{{ orochi_server_ip }}:{{ ports.rita }}</div>
              </a>
          </div>

          <div class="footer">
            <p>OROCHI Security Stack | Deployed via Ansible</p>
          </div>
      </body>
      </html>
    mode: '0644'
  tags: portal

- name: Pull Portal image
  community.docker.docker_image:
    name: "nginx:{{ portal_version }}"
    source: pull
  tags: portal

- name: Start Portal
  community.docker.docker_container:
    name: tool-portal
    image: "nginx:{{ portal_version }}"
    state: started
    restart_policy: unless-stopped
    hostname: tool-portal
    networks:
      - name: "{{ orochi_network_name }}"
    ports:
      - "{{ ports.portal_http }}:80"
    volumes:
      - "{{ directories.portal }}/html:/usr/share/nginx/html:ro"
  tags: portal

- name: Display Portal status
  ansible.builtin.debug:
    msg:
      - "OROCHI Portal is running!"
      - ""
      - "Access the dashboard: http://{{ orochi_server_ip }}:{{ ports.portal_http }}"
      - ""
      - "Click any service card to open that service directly."
  tags: portal
