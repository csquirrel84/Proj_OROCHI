---
# ==============================================
# RITA ROLE - Network Traffic Analysis
# ==============================================

- name: Create RITA directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - "{{ directories.rita }}"
    - "{{ directories.rita }}/config"
    - "{{ directories.rita }}/logs"
    - "{{ directories.mongodb }}"
  tags: rita

- name: Create RITA configuration
  ansible.builtin.copy:
    dest: "{{ directories.rita }}/config/config.yaml"
    content: |
      MongoDB:
        ConnectionString: mongodb://mongodb-rita:27017
        AuthenticationMechanism: null
        SocketTimeout: 2
        TLS:
          Enable: false
          VerifyCertificate: false
          CAFile: null

      LogLevel: 2
      LogPath: /logs

      Filtering:
        AlwaysInclude: []
        NeverInclude:
          - 0.0.0.0/32
          - 255.255.255.255/32
          - 127.0.0.0/8
          - 224.0.0.0/4
          - 240.0.0.0/4
          - ::1/128
          - fe80::/10
          - ff00::/8
        InternalSubnets:
          - 10.0.0.0/8
          - 172.16.0.0/12
          - 192.168.0.0/16

      Bro:
        ImportDirectory: /logs
        DBRoot: RITA
        MetaDB: MetaDatabase
        ImportBuffer: 100000

      BeaconFQDN:
        Enabled: true

      BeaconProxy:
        Enabled: true

      BeaconSNI:
        Enabled: true

      Beacon:
        Enabled: true
        DefaultConnectionThresh: 20

      DNS:
        Enabled: true

      Blacklisted:
        Enabled: true
        feodotracker:
          Enable: true
        MalwareDomains:
          Enable: true
    mode: '0644'
  tags: rita

# MongoDB for RITA
- name: Pull MongoDB image
  community.docker.docker_image:
    name: "mongo:{{ mongodb_version }}"
    source: pull
  tags: rita

- name: Start MongoDB for RITA
  community.docker.docker_container:
    name: mongodb-rita
    image: "mongo:{{ mongodb_version }}"
    state: started
    restart_policy: unless-stopped
    hostname: mongodb-rita
    networks:
      - name: "{{ orochi_network_name }}"
    volumes:
      - "{{ directories.mongodb }}:/data/db"
    memory: "{{ resources.mongodb.memory }}"
  tags: rita

- name: Wait for MongoDB
  ansible.builtin.pause:
    seconds: 10
  tags: rita

# RITA Backend
- name: Pull RITA image
  community.docker.docker_image:
    name: "quay.io/activecm/rita:{{ rita_version }}"
    source: pull
  tags: rita

- name: Start RITA backend
  community.docker.docker_container:
    name: rita
    image: "quay.io/activecm/rita:{{ rita_version }}"
    state: started
    restart_policy: unless-stopped
    hostname: rita
    networks:
      - name: "{{ orochi_network_name }}"
    ports:
      - "{{ ports.rita }}:80"
    volumes:
      - "{{ directories.rita }}/config:/root/.rita"
      - "{{ directories.rita }}/logs:/logs"
      - "/var/log/suricata:/logs/suricata:ro"
    env:
      RITA_CONFIG: "/root/.rita/config.yaml"
    memory: "{{ resources.rita.memory }}"
    command: ["sh", "-c", "while true; do sleep 3600; done"]
  tags: rita

- name: Display RITA status
  ansible.builtin.debug:
    msg:
      - "RITA is running!"
      - "URL: http://{{ orochi_server_ip }}:{{ ports.rita }}"
      - ""
      - "To import Suricata logs:"
      - "  docker exec rita rita import /logs/suricata dataset-name"
      - ""
      - "To view results:"
      - "  docker exec rita rita html-report"
  tags: rita
