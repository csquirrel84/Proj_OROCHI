---
# ==============================================
# 1. PREPARATION & DOWNLOAD
# ==============================================

- name: Create Velociraptor build directories
  ansible.builtin.file:
    path: /opt/orochi/velociraptor-build
    state: directory
    mode: '0755'

- name: Get latest Velociraptor release info from GitHub
  ansible.builtin.uri:
    url: https://api.github.com/repos/Velocidex/velociraptor/releases/latest
    return_content: true
  register: velox_release_info
  check_mode: false

- name: Parse download URL for Linux AMD64
  ansible.builtin.set_fact:
    velox_url: >-
      {{ 
        velox_release_info.json.assets 
        | selectattr('name', 'search', 'linux-amd64') 
        | rejectattr('name', 'search', 'sig') 
        | rejectattr('name', 'search', 'musl') 
        | map(attribute='browser_download_url') 
        | first 
      }}

- name: Download Velociraptor binary
  ansible.builtin.get_url:
    url: "{{ velox_url }}"
    dest: /opt/orochi/velociraptor-build/velociraptor
    mode: '0755'
    force: true  # Checks timestamp/size to ensure we always have the latest

- name: Create Velociraptor Dockerfile
  ansible.builtin.copy:
    dest: /opt/orochi/velociraptor-build/Dockerfile
    content: |
      FROM debian:bookworm-slim
      
      # Copy the binary downloaded by Ansible
      COPY velociraptor /usr/local/bin/velociraptor
      
      RUN mkdir -p /data
      WORKDIR /data
      EXPOSE 8000 8001 8889
      
      ENTRYPOINT ["/usr/local/bin/velociraptor"]
    mode: '0644'

- name: Build Velociraptor image
  community.docker.docker_image:
    name: orochi/velociraptor
    tag: latest
    source: build
    build:
      path: /opt/orochi/velociraptor-build
    state: present
    force_source: true

# ==============================================
# 2. CONFIGURATION
# ==============================================

- name: Create Velociraptor data directory
  ansible.builtin.file:
    path: /opt/orochi/velociraptor
    state: directory
    mode: '0755'

- name: Check if Velociraptor config exists
  ansible.builtin.stat:
    path: /opt/orochi/velociraptor/server.config.yaml
  register: velox_config

- name: Generate Velociraptor Configuration
  when: not velox_config.stat.exists
  block:
    - name: Create Velociraptor Merge Config
      ansible.builtin.copy:
        dest: /opt/orochi/velociraptor/merge.json
        content: |
          {
            "Client": {
              "server_urls": ["https://{{ selected_ip }}:8000/"],
              "use_self_signed_ssl": true
            },
            "API": {
              "bind_address": "0.0.0.0",
              "bind_port": 8001
            },
            "GUI": {
              "bind_address": "0.0.0.0",
              "bind_port": 8889,
              "public_url": "https://{{ selected_ip }}:8889/app/index.html"
            },
            "Frontend": {
              "bind_address": "0.0.0.0",
              "bind_port": 8000
            }
          }

    - name: Generate Server Config
      ansible.builtin.shell: |
        docker run --rm \
          -v /opt/orochi/velociraptor:/data \
          orochi/velociraptor:latest \
          config generate --merge_file /data/merge.json \
          > /opt/orochi/velociraptor/server.config.yaml

    - name: Generate Client Config
      ansible.builtin.shell: |
        docker run --rm \
          -v /opt/orochi/velociraptor:/data \
          orochi/velociraptor:latest \
          config client -c /data/server.config.yaml \
          > /opt/orochi/velociraptor/client.config.yaml

    - name: Remove merge file
      ansible.builtin.file:
        path: /opt/orochi/velociraptor/merge.json
        state: absent

# ==============================================
# 3. RUNTIME & USER CREATION
# ==============================================

- name: Start Velociraptor container
  community.docker.docker_container:
    name: velociraptor
    image: "orochi/velociraptor:latest"
    state: started
    restart_policy: unless-stopped
    recreate: true        # Forces container to update if image changed
    pull: never           # Uses local build
    networks:
      - name: orochi-network
    ports:
      - "8889:8889"
      - "8000:8000"
      - "8001:8001"
    volumes:
      - /opt/orochi/velociraptor:/data
    command:
      - "frontend"
      - "-v"
      - "--config"
      - "/data/server.config.yaml"

- name: Wait for Velociraptor to initialize
  ansible.builtin.pause:
    seconds: 10

- name: Create/Update Velociraptor Admin User
  ansible.builtin.shell: |
    docker exec velociraptor \
      velociraptor --config /data/server.config.yaml \
      user add --role administrator '{{ velox_user }}' '{{ common_password }}'
  register: velox_user_create
  changed_when: "'Created user' in velox_user_create.stdout"
  failed_when: 
    - velox_user_create.rc != 0
    - "'already exists' not in velox_user_create.stderr"

- name: Display Velociraptor Connection Info
  ansible.builtin.debug:
    msg: 
      - "Velociraptor GUI: https://{{ selected_ip }}:8889"
      - "Username: {{ velox_user }}"
      - "Password: {{ common_password }}"