---
# ==============================================
# COMMON ROLE - Docker & Base Setup
# ==============================================

- name: Display common setup info
  ansible.builtin.debug:
    msg: "Setting up common infrastructure on {{ inventory_hostname }}..."
  tags: common

# ============================================
# Docker Installation
# ============================================
- name: Check if Docker is installed
  ansible.builtin.command: docker --version
  register: docker_check
  ignore_errors: true
  changed_when: false
  tags: common

# Debian/Ubuntu Docker Installation
- name: Install Docker (Debian/Ubuntu)
  when:
    - docker_check.rc != 0
    - ansible_os_family == "Debian"
  tags: common
  block:
    - name: Install prerequisites
      ansible.builtin.apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
        state: present
        update_cache: true

    - name: Create keyrings directory
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'

    - name: Add Docker GPG key
      ansible.builtin.get_url:
        url: "https://download.docker.com/linux/{{ ansible_distribution | lower }}/gpg"
        dest: /etc/apt/keyrings/docker.asc
        mode: '0644'

    - name: Add Docker repository
      ansible.builtin.apt_repository:
        repo: "deb [arch={{ ansible_architecture | replace('x86_64', 'amd64') }} signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/{{ ansible_distribution | lower }} {{ ansible_distribution_release }} stable"
        state: present
        filename: docker

    - name: Install Docker packages
      ansible.builtin.apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present
        update_cache: true

# RHEL/CentOS/Fedora Docker Installation
- name: Install Docker (RHEL/CentOS/Fedora)
  when:
    - docker_check.rc != 0
    - ansible_os_family == "RedHat"
  tags: common
  block:
    - name: Install prerequisites
      ansible.builtin.yum:
        name:
          - yum-utils
        state: present

    - name: Add Docker repository
      ansible.builtin.yum_repository:
        name: docker-ce
        description: Docker CE Stable
        baseurl: "https://download.docker.com/linux/centos/$releasever/$basearch/stable"
        gpgcheck: true
        gpgkey: https://download.docker.com/linux/centos/gpg
        enabled: true

    - name: Install Docker packages
      ansible.builtin.yum:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present

# ============================================
# Start Docker Service
# ============================================
- name: Ensure Docker is running
  ansible.builtin.systemd:
    name: docker
    state: started
    enabled: true
  tags: common

# ============================================
# Python Docker SDK - System Packages
# ============================================
- name: Install Python Docker SDK (Debian/Ubuntu)
  ansible.builtin.apt:
    name:
      - python3-docker
      - python3-requests
      - python3-urllib3
    state: present
  when: ansible_os_family == "Debian"
  tags: common

- name: Install Python Docker SDK (RHEL/CentOS/Fedora)
  ansible.builtin.yum:
    name:
      - python3-docker
      - python3-requests
    state: present
  when: ansible_os_family == "RedHat"
  tags: common

# ============================================
# Create Docker Network
# ============================================
- name: Create Orochi Docker network
  community.docker.docker_network:
    name: "{{ orochi_network_name }}"
    state: present
  tags: common

# ============================================
# Create Base Directories
# ============================================
- name: Create base directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - "{{ orochi_base_path }}"
    - "{{ directories.logs }}"
  tags: common

# ============================================
# System Tuning for Elasticsearch
# ============================================
- name: Set vm.max_map_count for Elasticsearch
  ansible.posix.sysctl:
    name: vm.max_map_count
    value: '262144'
    state: present
    reload: true
  tags: common

# ============================================
# Verification
# ============================================
- name: Get Docker version
  ansible.builtin.command: docker --version
  register: docker_version
  changed_when: false
  tags: common

- name: Verify Docker SDK
  ansible.builtin.command: python3 -c "import docker; print(docker.__version__)"
  register: docker_sdk_version
  changed_when: false
  ignore_errors: true
  tags: common

- name: Common setup complete
  ansible.builtin.debug:
    msg:
      - "============================================"
      - "Common setup complete!"
      - "Docker: {{ docker_version.stdout }}"
      - "Docker SDK: {{ docker_sdk_version.stdout | default('installed') }}"
      - "Network: {{ orochi_network_name }}"
      - "Base path: {{ orochi_base_path }}"
      - "============================================"
  tags: common