---
# ==============================================
# ARKIME ROLE - Full Packet Capture (Bare Metal)
# ==============================================

- name: Check if Arkime is already installed
  ansible.builtin.command: dpkg -l arkime
  register: arkime_installed
  changed_when: false
  failed_when: false
  tags: arkime

- name: Download Arkime .deb package
  ansible.builtin.get_url:
    url: "https://github.com/arkime/arkime/releases/download/v{{ arkime_version }}/arkime_{{ arkime_version }}-1.ubuntu2404_amd64.deb"
    dest: "/tmp/arkime_{{ arkime_version }}.deb"
    mode: '0644'
  when: arkime_installed.rc != 0
  tags: arkime

- name: Install Arkime .deb package
  ansible.builtin.apt:
    deb: "/tmp/arkime_{{ arkime_version }}.deb"
    state: present
  when: arkime_installed.rc != 0
  tags: arkime

- name: Create Arkime PCAP directory
  ansible.builtin.file:
    path: "{{ directories.arkime }}/raw"
    state: directory
    mode: '0755'
    owner: nobody
    group: daemon
  tags: arkime

- name: Copy CA certificate for Elasticsearch trust
  ansible.builtin.copy:
    src: "{{ directories.certs }}/ca/ca.crt"
    dest: /opt/arkime/etc/ca.crt
    remote_src: true
    mode: '0644'
  tags: arkime

- name: Generate base64 Elasticsearch credentials
  ansible.builtin.shell: echo -n "elastic:{{ elasticsearch_password }}" | base64
  register: es_basic_auth
  changed_when: false
  no_log: true
  tags: arkime

- name: Write Arkime config.ini
  ansible.builtin.copy:
    dest: /opt/arkime/etc/config.ini
    content: |
      [default]
      elasticsearch=https://localhost:{{ ports.elasticsearch }}
      elasticsearchBasicAuth={{ es_basic_auth.stdout }}
      caTrustFile=/opt/arkime/etc/ca.crt
      passwordSecret={{ arkime_password_secret }}
      interface={{ suricata.interface }}
      pcapDir={{ directories.arkime }}/raw
      viewPort={{ ports.arkime }}
      maxFileSizeG=12
      freeSpaceG=5%
      rotateIndex=daily
      compressES=true
      dbBulkSize=1000000
      packetThreads=2
      dropUser=nobody
      dropGroup=daemon
      spiDataMaxIndices=5
      maxESConns=30
      maxESRequests=500
      dbFlushTimeout=5
      # GeoIP and OUI (downloaded by arkime_update_geo.sh)
      geoLite2Country=/opt/arkime/etc/GeoLite2-Country.mmdb
      geoLite2ASN=/opt/arkime/etc/GeoLite2-ASN.mmdb
      ouiFile=/opt/arkime/etc/oui.txt
      # Disable Wise by default
      viewerPlugins=
    mode: '0640'
    owner: root
    group: daemon
    backup: yes
  notify: restart arkime
  tags: arkime

- name: Wait for Elasticsearch to be ready
  ansible.builtin.uri:
    url: "https://localhost:{{ ports.elasticsearch }}/_cluster/health"
    method: GET
    user: elastic
    password: "{{ elasticsearch_password }}"
    validate_certs: false
    status_code: 200
  register: es_health
  until: es_health.status == 200
  retries: 30
  delay: 10
  tags: arkime

- name: Check if Arkime users index exists
  ansible.builtin.uri:
    url: "https://localhost:{{ ports.elasticsearch }}/arkime_users"
    method: HEAD
    user: elastic
    password: "{{ elasticsearch_password }}"
    validate_certs: false
    status_code: [200, 404]
  register: arkime_users_check
  tags: arkime

- name: Initialize Arkime Elasticsearch indices
  ansible.builtin.command: >
    /opt/arkime/db/db.pl
    --esuser "elastic:{{ elasticsearch_password }}"
    --insecure
    https://localhost:{{ ports.elasticsearch }}
    init
    --ilm
  register: arkime_db_init
  failed_when:
    - arkime_db_init.rc != 0
    - "'already' not in (arkime_db_init.stdout | default('') + arkime_db_init.stderr | default(''))"
  when: arkime_users_check.status == 404
  no_log: true
  tags: arkime

- name: Configure ILM policy (1-day rotation, 30-day retention)
  ansible.builtin.command: >
    /opt/arkime/db/db.pl
    --esuser "elastic:{{ elasticsearch_password }}"
    --insecure
    https://localhost:{{ ports.elasticsearch }}
    ilm 1d 30d
  register: arkime_ilm
  failed_when:
    - arkime_ilm.rc != 0
    - "'already' not in (arkime_ilm.stdout | default('') + arkime_ilm.stderr | default(''))"
  when: arkime_users_check.status == 404
  no_log: true
  tags: arkime

- name: Create Arkime admin user
  ansible.builtin.command:
    argv:
      - /opt/arkime/bin/arkime_add_user.sh
      - admin
      - "Admin User"
      - "{{ arkime_password }}"
      - --admin
  register: arkime_user_create
  failed_when:
    - arkime_user_create.rc != 0
    - "'already' not in (arkime_user_create.stdout | default('') + arkime_user_create.stderr | default(''))"
  no_log: true
  tags: arkime

- name: Download GeoIP databases and OUI file
  ansible.builtin.command: /opt/arkime/bin/arkime_update_geo.sh
  register: arkime_geo_update
  changed_when: true
  failed_when: false
  tags: arkime

- name: Check if GeoIP Country database exists
  ansible.builtin.stat:
    path: /opt/arkime/etc/GeoLite2-Country.mmdb
  register: geo_country_check
  tags: arkime

- name: Check if GeoIP ASN database exists
  ansible.builtin.stat:
    path: /opt/arkime/etc/GeoLite2-ASN.mmdb
  register: geo_asn_check
  tags: arkime

- name: Display GeoIP status
  ansible.builtin.debug:
    msg:
      - "GeoIP Country: {{ 'OK' if geo_country_check.stat.exists else 'MISSING (non-fatal, capture will run without GeoIP enrichment)' }}"
      - "GeoIP ASN: {{ 'OK' if geo_asn_check.stat.exists else 'MISSING (non-fatal, capture will run without GeoIP enrichment)' }}"
      - "OUI file: check /opt/arkime/etc/oui.txt"
      - "Geo update output: {{ arkime_geo_update.stdout_lines | default([]) }}"
  tags: arkime

- name: Create Arkime logs directory
  ansible.builtin.file:
    path: /opt/arkime/logs
    state: directory
    mode: '0755'
    owner: nobody
    group: daemon
  tags: arkime

- name: Create Arkime viewer environment file
  ansible.builtin.copy:
    dest: /opt/arkime/etc/viewer.env
    content: |
      OPTIONS=
    mode: '0644'
  tags: arkime

- name: Create Arkime capture environment file
  ansible.builtin.copy:
    dest: /opt/arkime/etc/capture.env
    content: |
      OPTIONS=
    mode: '0644'
  tags: arkime

- name: Create systemd override directories
  ansible.builtin.file:
    path: "/etc/systemd/system/{{ item }}.service.d"
    state: directory
    mode: '0755'
  loop:
    - arkimecapture
    - arkimeviewer
  tags: arkime

- name: Create systemd override for Arkime services
  ansible.builtin.copy:
    dest: "/etc/systemd/system/{{ item }}.service.d/override.conf"
    content: |
      [Service]
      Environment="OPTIONS="
    mode: '0644'
  loop:
    - arkimecapture
    - arkimeviewer
  notify: restart arkime
  tags: arkime

- name: Enable and start Arkime capture service
  ansible.builtin.systemd:
    name: arkimecapture
    enabled: yes
    state: started
    daemon_reload: yes
  tags: arkime

- name: Enable and start Arkime viewer service
  ansible.builtin.systemd:
    name: arkimeviewer
    enabled: yes
    state: started
    daemon_reload: yes
  tags: arkime

- name: Wait for Arkime Viewer to be ready
  ansible.builtin.wait_for:
    host: localhost
    port: "{{ ports.arkime }}"
    delay: 5
    timeout: 60
    state: started
  register: arkime_viewer_wait
  ignore_errors: true
  tags: arkime

- name: Show arkimeviewer.service unit file
  ansible.builtin.command: systemctl cat arkimeviewer.service
  register: arkime_viewer_unit
  changed_when: false
  when: arkime_viewer_wait is failed
  tags: arkime

- name: Display viewer unit file
  ansible.builtin.debug:
    msg: "{{ arkime_viewer_unit.stdout_lines }}"
  when: arkime_viewer_wait is failed
  tags: arkime

- name: Check Arkime log files
  ansible.builtin.command: ls -la /opt/arkime/logs/
  register: arkime_log_files
  changed_when: false
  failed_when: false
  when: arkime_viewer_wait is failed
  tags: arkime

- name: Show Arkime viewer log if exists
  ansible.builtin.shell: "tail -30 /opt/arkime/logs/viewer.log 2>/dev/null || echo 'No viewer.log found'"
  register: arkime_viewer_logfile
  changed_when: false
  when: arkime_viewer_wait is failed
  tags: arkime

- name: Display diagnostics
  ansible.builtin.debug:
    msg:
      - "=== Log files ==="
      - "{{ arkime_log_files.stdout_lines | default(['No logs dir']) }}"
      - "=== Viewer log ==="
      - "{{ arkime_viewer_logfile.stdout_lines | default(['No viewer log']) }}"
  when: arkime_viewer_wait is failed
  tags: arkime

- name: Fail if viewer did not start
  ansible.builtin.fail:
    msg: "Arkime Viewer failed to start on port {{ ports.arkime }}. Check diagnostics above."
  when: arkime_viewer_wait is failed
  tags: arkime

- name: Check Arkime service status
  ansible.builtin.command: systemctl status {{ item }}
  register: arkime_service_status
  loop:
    - arkimecapture
    - arkimeviewer
  changed_when: false
  failed_when: false
  tags: arkime

- name: Display Arkime status
  ansible.builtin.debug:
    msg:
      - "Arkime {{ arkime_version }} installed on bare metal!"
      - ""
      - "Viewer URL: http://{{ orochi_server_ip }}:{{ ports.arkime }}"
      - "Username: admin"
      - "Password: [Check vars/secrets.yml]"
      - "Capture Interface: {{ suricata.interface }}"
      - "PCAP Directory: {{ directories.arkime }}/raw"
      - "Config: /opt/arkime/etc/config.ini"
      - "Elasticsearch: https://localhost:{{ ports.elasticsearch }} ({{ es_health.json.status }})"
      - ""
      - "Useful commands:"
      - "  sudo systemctl status arkimecapture    - Capture status"
      - "  sudo systemctl status arkimeviewer     - Viewer status"
      - "  sudo systemctl restart arkimecapture   - Restart capture"
      - "  sudo systemctl restart arkimeviewer    - Restart viewer"
  tags: arkime
