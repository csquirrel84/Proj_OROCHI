---
# ==============================================
# ENVIRONMENT ROLE - Load configuration from .env
# ==============================================
# deploy.sh creates .env with all configuration.
# This role loads it and sets Ansible facts that
# other roles depend on. No interactive prompts.
# ==============================================

# 1. CHECK FOR .ENV
- name: Check for .env configuration
  ansible.builtin.stat:
    path: "{{ playbook_dir }}/.env"
  register: env_file
  tags: environment

- name: Fail if .env missing
  ansible.builtin.fail:
    msg: |
      No .env configuration found!
      Run deploy.sh first to configure the stack:
        ./deploy.sh
  when: not env_file.stat.exists
  tags: environment

# 2. LOAD AND PARSE .ENV
- name: Read .env file
  ansible.builtin.slurp:
    src: "{{ playbook_dir }}/.env"
  register: env_raw
  tags: environment

- name: Decode .env content
  ansible.builtin.set_fact:
    env_content: "{{ env_raw.content | b64decode }}"
  no_log: true
  tags: environment

- name: Parse .env configuration
  ansible.builtin.set_fact:
    stack_version: "{{ env_content | regex_search('STACK_VERSION=(.+)', '\\1') | first | default('9.3.0', true) }}"
    cluster_name: "{{ env_content | regex_search('CLUSTER_NAME=(.+)', '\\1') | first | default('orochi', true) }}"
    license: "{{ env_content | regex_search('LICENSE=(.+)', '\\1') | first | default('trial', true) }}"
    velox_user: "{{ env_content | regex_search('VELOX_USER=(.+)', '\\1') | first | default('admin', true) }}"
    velox_role: "{{ env_content | regex_search('VELOX_ROLE=(.+)', '\\1') | first | default('administrator', true) }}"
    velox_server_url: "{{ env_content | regex_search('VELOX_SERVER_URL=(.+)', '\\1') | first | default('https://127.0.0.1:8889/', true) }}"
    velox_hostname: "{{ env_content | regex_search('VELOX_FRONTEND_HOSTNAME=(.+)', '\\1') | first | default('127.0.0.1', true) }}"
    es_port: "{{ env_content | regex_search('ES_PORT=(.+)', '\\1') | first | default('9200', true) }}"
    kibana_port: "{{ env_content | regex_search('KIBANA_PORT=(.+)', '\\1') | first | default('5601', true) }}"
    fleet_port: "{{ env_content | regex_search('FLEET_PORT=(.+)', '\\1') | first | default('8220', true) }}"
    pcap_interface: "{{ env_content | regex_search('PCAP_INTERFACE=(.+)', '\\1') | first | default('eth0', true) }}"
    suricata_interface: "{{ env_content | regex_search('SURICATA_INTERFACE=(.+)', '\\1') | first | default('eth0', true) }}"
    suricata_home_net: "{{ env_content | regex_search('SURICATA_HOME_NET=(.+)', '\\1') | first | default('192.168.0.0/16', true) }}"
    ingestion_ip: "{{ env_content | regex_search('INGESTION_IP=(.+)', '\\1') | first | default('127.0.0.1', true) }}"
    access_ip: "{{ env_content | regex_search('ACCESS_IP=(.+)', '\\1') | first | default('127.0.0.1', true) }}"
    selected_ip: "{{ env_content | regex_search('SELECTED_IP=(.+)', '\\1') | first | default('127.0.0.1', true) }}"
    arkime_es_ip: "{{ env_content | regex_search('ARKIME_ELASTICSEARCH_IP=(.+)', '\\1') | first | default('127.0.0.1', true) }}"
    arkime_password_secret: "{{ env_content | regex_search('ARKIME_PASSWORD_SECRET=(.+)', '\\1') | first | default('', true) }}"
    kibana_encryption_key: "{{ env_content | regex_search('KIBANA_ENCRYPTION_KEY=(.+)', '\\1') | first | default('', true) }}"
    local_kbn_url: "{{ env_content | regex_search('LOCAL_KBN_URL=(.+)', '\\1') | first | default('https://127.0.0.1:5601', true) }}"
  no_log: true
  tags: environment

# 3. PARSE DEPLOYED COMPONENTS LIST
- name: Parse deployed components
  ansible.builtin.set_fact:
    deployed_components: "{{ (env_content | regex_search('DEPLOYED_COMPONENTS=(.+)', '\\1') | first | default('elk,thehive,velociraptor,suricata,zeek,arkime,cyberchef,mattermost,rita,portal', true)).split(',') }}"
  tags: environment

# 4. SET SURICATA CONFIG DICT
# This overrides group_vars/all.yml defaults with actual .env values
- name: Set suricata configuration
  ansible.builtin.set_fact:
    suricata:
      interface: "{{ pcap_interface }}"
      home_net: "{{ suricata_home_net }}"
  tags: environment

# 4. VERIFY PASSWORD FROM VAULT
- name: Verify common_password is available
  ansible.builtin.fail:
    msg: |
      common_password not found! Ensure vars/secrets.yml exists and
      you are passing the vault password:
        ansible-playbook fuse.yml --ask-vault-pass
        ansible-playbook fuse.yml --vault-password-file .vault_pass
  when: common_password is not defined or common_password == ""
  tags: environment

# 5. DISPLAY CONFIGURATION SUMMARY
- name: Display loaded configuration
  ansible.builtin.debug:
    msg:
      - "Configuration loaded from .env"
      - "Stack Version: {{ stack_version }}"
      - "Analyst Access IP: {{ access_ip }}"
      - "Log Ingestion IP: {{ ingestion_ip }}"
      - "PCAP Interface: {{ pcap_interface }}"
      - "HOME_NET: {{ suricata_home_net }}"
  tags: environment
