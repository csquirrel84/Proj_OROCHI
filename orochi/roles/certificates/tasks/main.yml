---
# ==============================================
# CERTIFICATES ROLE - Robust Single Cert Method
# ==============================================

- name: Create certificates directory
  ansible.builtin.file:
    path: "{{ directories.certs }}"
    state: directory
    mode: '0755'
    owner: 1000
    group: 1000
  tags: certificates

- name: Check if CA certificate exists
  ansible.builtin.stat:
    path: "{{ directories.certs }}/ca/ca.crt"
  register: ca_cert_check
  tags: certificates

- name: Check if Elasticsearch leaf key exists
  ansible.builtin.stat:
    path: "{{ directories.certs }}/elasticsearch/elasticsearch.key"
  register: es_key_check
  tags: certificates

- name: Generate and Distribute Certificates
  when: (not ca_cert_check.stat.exists) or (not es_key_check.stat.exists)
  tags: certificates
  block:
    - name: Generate certificates using Elasticsearch container
      ansible.builtin.shell: |
        docker run --rm \
          -v {{ directories.certs }}:/usr/share/elasticsearch/config/certs \
          docker.elastic.co/elasticsearch/elasticsearch:{{ stack_version }} \
          bash -c '
            set -euo pipefail
            cd /usr/share/elasticsearch

            # 1. Generate CA
            bin/elasticsearch-certutil ca --silent --pem -out config/certs/ca.zip
            unzip -o config/certs/ca.zip -d config/certs

            # 2. Generate Single Stack Certificate (valid for all services)
            bin/elasticsearch-certutil cert --silent --pem \
              --ca-cert config/certs/ca/ca.crt \
              --ca-key config/certs/ca/ca.key \
              --name orochi \
              --dns elasticsearch \
              --dns kibana \
              --dns fleet-server \
              --dns localhost \
              --ip 127.0.0.1 \
              --ip {{ orochi_server_ip }} \
              --ip {{ fleet_server_ip }} \
              --out config/certs/certs.zip \
              --days 1095 \

            unzip -o config/certs/certs.zip -d config/certs

            # 3. Create Service Directories
            mkdir -p config/certs/elasticsearch
            mkdir -p config/certs/kibana
            mkdir -p config/certs/fleet-server

            # 4. Copy Keys to Expected Locations
            # Elasticsearch
            cp config/certs/orochi/orochi.crt config/certs/elasticsearch/elasticsearch.crt
            cp config/certs/orochi/orochi.key config/certs/elasticsearch/elasticsearch.key

            # Kibana
            cp config/certs/orochi/orochi.crt config/certs/kibana/kibana.crt
            cp config/certs/orochi/orochi.key config/certs/kibana/kibana.key

            # Fleet Server
            cp config/certs/orochi/orochi.crt config/certs/fleet-server/fleet-server.crt
            cp config/certs/orochi/orochi.key config/certs/fleet-server/fleet-server.key

            # 5. Set Permissions
            chmod -R 755 config/certs
            find config/certs -name "*.key" -exec chmod 644 {} \;
          '
      register: cert_gen_output

    - name: Cleanup temporary zip files
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ directories.certs }}/ca.zip"
        - "{{ directories.certs }}/certs.zip"

- name: Recursive Permission Fix
  ansible.builtin.file:
    path: "{{ directories.certs }}"
    state: directory
    recurse: yes
    owner: 1000
    group: 1000
    mode: '0755'
  tags: certificates

- name: Secure Private Keys
  ansible.builtin.shell: find {{ directories.certs }} -name "*.key" -exec chmod 600 {} \;
  tags: certificates

- name: Get CA fingerprint
  ansible.builtin.shell: |
    openssl x509 -fingerprint -sha256 -noout -in {{ directories.certs }}/ca/ca.crt | cut -d= -f2 | tr -d :
  register: ca_fingerprint_result
  changed_when: false
  tags: certificates

- name: Store CA fingerprint
  ansible.builtin.set_fact:
    ca_fingerprint: "{{ ca_fingerprint_result.stdout }}"
  tags: certificates

- name: Read CA certificate content
  ansible.builtin.slurp:
    src: "{{ directories.certs }}/ca/ca.crt"
  register: ca_cert_content
  tags: certificates

- name: Store CA certificate
  ansible.builtin.set_fact:
    ca_certificate: "{{ ca_cert_content.content | b64decode }}"
  tags: certificates

- name: Certificates Ready
  ansible.builtin.debug:
    msg: "Certificates generated and distributed to elasticsearch/, kibana/, and fleet-server/ folders."
  tags: certificates
