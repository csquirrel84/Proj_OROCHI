#!/usr/bin/env ansible-playbook
---
- name: Teardown Orochi Stack
  hosts: orochi_servers
  become: true
  gather_facts: false
  
  vars:
    orochi_base_path: /opt/orochi

  tasks:
    - name: Force kill and remove containers
      ansible.builtin.shell: "docker rm -f {{ item }} || true"
      loop:
        - nginx-proxy
        - mattermost
        - postgres-mattermost
        - cyberchef
        - arkime
        - suricata
        - velociraptor
        - thehive
        - cassandra
        - elasticsearch-hive
        - fleet-server
        - kibana
        - elasticsearch
      register: remove_output
      changed_when: "'No such container' not in remove_output.stderr"

    - name: Remove Docker network
      ansible.builtin.shell: "docker network rm orochi-network || true"
      ignore_errors: true

    - name: Prompt for Data Removal
      ansible.builtin.pause:
        prompt: |
          Choose cleanup level:
          1. Reset Data (Keep .env config, delete databases/logs/certs)
          2. Full Wipe (Delete EVERYTHING including .env)
          3. Cancel (Keep files)
          Enter 1, 2, or 3
      register: cleanup_choice

    - name: Reset Data (Keep .env)
      when: cleanup_choice.user_input == "1"
      block:
        - name: Find all directories in base path
          ansible.builtin.find:
            paths: "{{ orochi_base_path }}"
            file_type: directory
          register: orochi_dirs

        - name: Remove subdirectories (keeps files in root like .env)
          ansible.builtin.file:
            path: "{{ item.path }}"
            state: absent
          loop: "{{ orochi_dirs.files }}"
        
        - name: Remove generated files (except .env)
          ansible.builtin.shell: "find {{ orochi_base_path }} -maxdepth 1 -type f -not -name '.env' -delete"

    - name: Full Wipe (Delete Everything)
      ansible.builtin.file:
        path: "{{ orochi_base_path }}"
        state: absent
      when: cleanup_choice.user_input == "2"

    - name: Status Message
      ansible.builtin.debug:
        msg:
          - "Containers removed."
          - "{% if cleanup_choice.user_input == '1' %}Data reset. Config preserved at {{ orochi_base_path }}/.env{% endif %}"
          - "{% if cleanup_choice.user_input == '2' %}Full wipe complete. {{ orochi_base_path }} removed.{% endif %}"