#!/usr/bin/env ansible-playbook
---
- name: Teardown Orochi Stack
  hosts: orochi_servers
  become: true
  gather_facts: false
  
  vars:
    orochi_base_path: /opt/orochi

  tasks:
    - name: Stop Zeek service (if running on bare metal)
      ansible.builtin.systemd:
        name: zeek
        state: stopped
        enabled: no
      ignore_errors: true

    - name: Stop Suricata service (if running on bare metal)
      ansible.builtin.systemd:
        name: suricata
        state: stopped
        enabled: no
      ignore_errors: true

    - name: Stop Arkime services (if running on bare metal)
      ansible.builtin.systemd:
        name: "{{ item }}"
        state: stopped
        enabled: no
      loop:
        - arkimecapture
        - arkimeviewer
      ignore_errors: true

    - name: Force kill and remove containers
      ansible.builtin.shell: "docker rm -f {{ item }} || true"
      loop:
        - tool-portal  # Tool Portal
        - mattermost
        - postgres-mattermost
        - cyberchef
        - arkime
        - suricata
        - velociraptor
        - thehive
        - cassandra
        - elasticsearch-hive
        - fleet-server
        - kibana
        - elasticsearch
      register: remove_output
      changed_when: "'No such container' not in remove_output.stderr"

    - name: Remove Docker network
      ansible.builtin.shell: "docker network rm orochi-network || true"
      ignore_errors: true

    - name: Prompt for Data Removal
      ansible.builtin.pause:
        prompt: |
          Choose cleanup level:
          1. Reset Data (delete databases/logs/certs on target)
          2. Full Wipe (delete {{ orochi_base_path }} on target)
          3. Cancel (keep files)
          Note: .env config is on control node and unaffected
          Enter 1, 2, or 3
      register: cleanup_choice

    - name: Reset Data (Remove subdirectories)
      when: cleanup_choice.user_input == "1"
      block:
        - name: Find all directories in base path
          ansible.builtin.find:
            paths: "{{ orochi_base_path }}"
            file_type: directory
          register: orochi_dirs

        - name: Remove subdirectories
          ansible.builtin.file:
            path: "{{ item.path }}"
            state: absent
          loop: "{{ orochi_dirs.files }}"

    - name: Full Wipe (Delete Everything on target)
      ansible.builtin.file:
        path: "{{ orochi_base_path }}"
        state: absent
      when: cleanup_choice.user_input == "2"

    - name: Status Message
      ansible.builtin.debug:
        msg:
          - "Containers removed."
          - "{% if cleanup_choice.user_input == '1' %}Data reset on target. {{ orochi_base_path }} subdirectories removed.{% endif %}"
          - "{% if cleanup_choice.user_input == '2' %}Full wipe complete. {{ orochi_base_path }} removed from target.{% endif %}"
          - "Config preserved at ./orochi/.env on control node."